# üöÄ GU√çA COMPLETA: CONFIGURAR TRAEFIK EN COOLIFY

## üéØ OBJETIVO:
Configurar Traefik como reverse proxy en Coolify para:
- ‚úÖ HTTPS autom√°tico con certificados SSL
- ‚úÖ Redirecci√≥n HTTP ‚Üí HTTPS
- ‚úÖ Gesti√≥n autom√°tica de certificados
- ‚úÖ Load balancing y seguridad

## üìã PRERREQUISITOS:
- Coolify instalado y funcionando
- Acceso al servidor Coolify
- Dominio o subdominio apuntando al servidor

## üîß PASO 1: INSTALAR TRAEFIK EN COOLIFY

### OPCI√ìN A: INSTALACI√ìN COMO SERVICIO EN COOLIFY

1. **Ir al Dashboard de Coolify:**
   - https://tu-coolify-ip:3000

2. **Crear nuevo proyecto:**
   - Clic en "New Project"
   - Seleccionar "Docker Compose"

3. **Configurar Docker Compose para Traefik:**

```yaml
version: '3.8'

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard de Traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/traefik.yml:ro
      - ./dynamic.yml:/dynamic.yml:ro
      - ./letsencrypt:/letsencrypt
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.tudominio.com`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"

networks:
  traefik:
    external: false
```

### OPCI√ìN B: INSTALACI√ìN MANUAL EN EL SERVIDOR

1. **Conectar al servidor Coolify:**
```bash
ssh usuario@servidor-coolify
```

2. **Crear directorio para Traefik:**
```bash
mkdir -p /opt/traefik
cd /opt/traefik
```

3. **Crear archivo de configuraci√≥n principal:**
```bash
nano traefik.yml
```

## üîß PASO 2: CONFIGURAR TRAEFIK.YML

Crear archivo `/opt/traefik/traefik.yml`:

```yaml
api:
  dashboard: true
  insecure: false

entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entrypoint:
          to: websecure
          scheme: https
  websecure:
    address: ":443"

certificatesResolvers:
  letsencrypt:
    acme:
      email: tu-email@ejemplo.com
      storage: /letsencrypt/acme.json
      httpChallenge:
        entryPoint: web

providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
  file:
    filename: /dynamic.yml
    watch: true

log:
  level: INFO

accessLog: {}

metrics:
  prometheus:
    addEntryPointsLabels: true
    addServicesLabels: true
```

## üîß PASO 3: CONFIGURAR DYNAMIC.YML

Crear archivo `/opt/traefik/dynamic.yml`:

```yaml
http:
  middlewares:
    security-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 100
        hostsProxyHeaders:
          - "X-Forwarded-Host"
        referrerPolicy: "strict-origin-when-cross-origin"
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
    redirect-https:
      redirectScheme:
        scheme: https
        permanent: true

  routers:
    tv-radio:
      rule: "Host(`v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io`)"
      entrypoints:
        - websecure
      tls:
        certresolver: letsencrypt
      service: tv-radio
      middlewares:
        - security-headers

  services:
    tv-radio:
      loadBalancer:
        servers:
          - url: "http://localhost:3000"
        healthCheck:
          path: "/"
          interval: "30s"
          timeout: "3s"
```

## üîß PASO 4: CONFIGURAR TU APLICACI√ìN TV-RADIO

### MODIFICAR DOCKER COMPOSE DE TV-RADIO

En el proyecto TV-radio en Coolify, agregar labels a tu servicio:

```yaml
services:
  tv-radio:
    image: tu-imagen-tv-radio
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tv-radio.rule=Host(`v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io`)"
      - "traefik.http.routers.tv-radio.entrypoints=websecure"
      - "traefik.http.routers.tv-radio.tls.certresolver=letsencrypt"
      - "traefik.http.services.tv-radio.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.security-headers.headers.accessControlAllowOriginList=*"
```

## üîß PASO 5: CONFIGURAR DNS

### CONFIGURAR DNS PARA TU DOMINIO

**Opci√≥n A: Usar subdominio de dominio existente**
```
Type: A
Name: tv-radio (o el subdominio que prefieras)
Value: IP_DEL_SERVIDOR_COOLIFY
TTL: 300
```

**Opci√≥n B: Si usas el dominio .sslip.io**
```
Type: A
Name: v8g48ggkk8wko4480s8kk4ok
Value: IP_DEL_SERVIDOR_COOLIFY
TTL: 300
```

## üîß PASO 6: INICIAR TRAEFIK

### INICIAR CON DOCKER COMPOSE

```bash
cd /opt/traefik
docker-compose up -d
```

### VERIFICAR QUE EST√Å FUNCIONANDO

```bash
docker ps
curl http://localhost:8080  # Dashboard de Traefik
```

## üîß PASO 7: CONFIGURAR FIREWALL

### ABRIR PUERTOS NECESARIOS

```bash
# Ubuntu/Debian
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 8080  # Dashboard (opcional)

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
```

## üîß PASO 8: VERIFICAR CONFIGURACI√ìN

### VERIFICAR HTTPS

```bash
curl -I https://v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io
```

### VERIFICAR REDIRECCI√ìN HTTP ‚Üí HTTPS

```bash
curl -I http://v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io
# Debe redirigir a HTTPS
```

### VERIFICAR CERTIFICADO SSL

```bash
openssl s_client -connect v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io:443 -servername v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io
```

## üéØ RESULTADO ESPERADO:

Despu√©s de la configuraci√≥n:
- ‚úÖ **HTTPS autom√°tico** con certificados Let's Encrypt
- ‚úÖ **Redirecci√≥n HTTP ‚Üí HTTPS** autom√°tica
- ‚úÖ **Certificados SSL** renovados autom√°ticamente
- ‚úÖ **Dashboard Traefik** en puerto 8080
- ‚úÖ **Seguridad** con headers de seguridad
- ‚úÖ **OAuth funcionando** sin errores

## üîë URLs PARA GOOGLE CLOUD:

```
https://v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io/callback
https://v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io/auth/callback
https://v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io/oauth/callback
https://v8g48ggkk8wko4480s8kk4ok.147.93.182.94.sslip.io/auth/google/callback
```

## üõ†Ô∏è TROUBLESHOOTING:

### VER LOGS DE TRAEFIK
```bash
docker logs traefik
```

### VERIFICAR CONFIGURACI√ìN
```bash
docker exec traefik cat /traefik.yml
```

### REINICIAR TRAEFIK
```bash
docker-compose restart traefik
```

## ‚ö° VENTAJAS DE TRAEFIK:

- ‚úÖ **Certificados autom√°ticos** Let's Encrypt
- ‚úÖ **Renovaci√≥n autom√°tica** de certificados
- ‚úÖ **Dashboard web** para monitoreo
- ‚úÖ **Load balancing** integrado
- ‚úÖ **Middleware** de seguridad
- ‚úÖ **M√©tricas** Prometheus
- ‚úÖ **Health checks** autom√°ticos

**¬øNecesitas ayuda con alg√∫n paso espec√≠fico de la configuraci√≥n de Traefik?**